<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudBin - Firestore Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <!-- Navigation -->
    <nav class="bg-white shadow-md p-4 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.hash='#dashboard'">
                <i class="fa-solid fa-cloud text-blue-600 text-2xl"></i>
                <span class="font-bold text-xl tracking-tight">CloudBin</span>
            </div>
            <div id="nav-auth" class="hidden flex items-center gap-4">
                <span id="user-email" class="text-sm text-gray-500 hidden md:block"></span>
                <button id="btn-logout" class="text-sm text-red-500 hover:text-red-700 font-medium">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-5xl mx-auto p-4 mt-6">
        
        <!-- Loading Screen -->
        <div id="view-loading" class="view flex flex-col items-center justify-center h-64">
            <div class="loader mb-4"></div>
            <p class="text-gray-500">Connecting to CloudBin...</p>
        </div>

        <!-- Login View -->
        <div id="view-login" class="view hidden flex flex-col items-center justify-center pt-10">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-2">Welcome Back</h2>
                <p class="text-gray-500 mb-8">Sign in to access your files</p>
                
                <div class="space-y-4">
                    <button id="btn-google" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-3 rounded-lg flex items-center justify-center gap-3 transition shadow-sm">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                        Continue with Google
                    </button>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">Or email</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <form id="email-form" class="space-y-3 text-left">
                        <input type="email" id="inp-email" placeholder="Email" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="inp-password" placeholder="Password" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex gap-2">
                            <button type="button" id="btn-signin" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition">Sign In</button>
                            <button type="button" id="btn-signup" class="flex-1 bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-lg font-medium transition">Sign Up</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">My Files</h1>
                <a href="#upload" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 transition">
                    <i class="fa-solid fa-plus"></i> Upload New
                </a>
            </div>

            <div id="file-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Files injected here -->
            </div>
            <div id="empty-state" class="hidden text-center py-20 text-gray-400">
                <i class="fa-regular fa-folder-open text-6xl mb-4"></i>
                <p>No files found. Start by uploading one!</p>
            </div>
        </div>

        <!-- Upload View -->
        <div id="view-upload" class="view hidden">
            <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-xl font-bold">Upload File</h2>
                    <a href="#dashboard" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></a>
                </div>

                <div class="space-y-6">
                    <div class="border-2 border-dashed border-blue-200 bg-blue-50 rounded-xl p-10 text-center hover:bg-blue-100 transition cursor-pointer relative">
                        <input type="file" id="file-input" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                        <i class="fa-solid fa-cloud-arrow-up text-4xl text-blue-500 mb-3"></i>
                        <p class="text-gray-600 font-medium">Click or Drag file to upload</p>
                        <p class="text-xs text-gray-400 mt-1">Note: Files are chunked. Large files may take time.</p>
                    </div>

                    <div id="upload-progress-container" class="hidden">
                        <div class="flex justify-between text-sm mb-1">
                            <span id="upload-status">Processing...</span>
                            <span id="upload-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Detail/View -->
        <div id="view-file" class="view hidden">
            <div class="mb-4">
                <a href="#dashboard" class="text-blue-600 hover:underline text-sm"><i class="fa-solid fa-arrow-left"></i> Back to Dashboard</a>
            </div>
            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                <div id="file-preview-icon" class="mb-6">
                    <i class="fa-solid fa-file text-6xl text-gray-300"></i>
                </div>
                <h1 id="file-name-display" class="text-2xl font-bold break-words mb-2">filename.ext</h1>
                <p id="file-meta-display" class="text-gray-500 text-sm mb-8">Size: -- | Type: --</p>

                <div id="download-section">
                    <p id="reassembly-status" class="text-sm text-blue-600 mb-4 hidden"><i class="fa-solid fa-circle-notch fa-spin"></i> Reassembling chunks...</p>
                    <button id="btn-download" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold shadow transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-download"></i> Download / View
                    </button>
                    <p id="error-msg" class="text-red-500 mt-4 hidden"></p>
                </div>
                
                <div id="preview-container" class="mt-8 hidden border-t pt-6">
                    <h3 class="text-lg font-semibold mb-4 text-left">Preview</h3>
                    <div id="media-preview" class="border rounded bg-gray-50 p-2 overflow-auto max-h-96"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 z-50">
        Notification
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        // Use stable versions for Auth and Firestore to ensure compatibility
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, doc, deleteDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCT6JM1Njg3D9IwicsxJdo2MKjP3gGfUqU",
            authDomain: "cloudbin-dd657.firebaseapp.com",
            projectId: "cloudbin-dd657",
            storageBucket: "cloudbin-dd657.firebasestorage.app",
            messagingSenderId: "118062759614",
            appId: "1:118062759614:web:d98af3c2b125d131bf68ef",
            measurementId: "G-QYLJF2DWCX"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State & Constants ---
        let currentUser = null;
        // Safe chunk size: 500KB. Base64 increases size by ~33%.
        // 500KB * 1.33 = ~665KB, well under the 1MB Firestore limit.
        const CHUNK_SIZE_BYTES = 500 * 1024; 

        // --- Routing ---
        const routes = {
            '': 'view-loading',
            '#login': 'view-login',
            '#dashboard': 'view-dashboard',
            '#upload': 'view-upload',
            '#file': 'view-file' // Handles #view?id=xyz via partial match logic
        };

        function handleRoute() {
            const hash = window.location.hash.split('?')[0] || '';
            const queryParams = new URLSearchParams(window.location.hash.split('?')[1]);

            // Auth Guard
            if (!currentUser && hash !== '#login') {
                window.location.hash = '#login';
                return;
            }
            if (currentUser && hash === '#login') {
                window.location.hash = '#dashboard';
                return;
            }

            // Hide all views
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));

            // specific view logic
            if (hash === '#view') {
                const fileId = queryParams.get('id');
                if (fileId) {
                    document.getElementById('view-file').classList.remove('hidden');
                    loadFileDetails(fileId);
                } else {
                    window.location.hash = '#dashboard';
                }
            } else if (routes[hash]) {
                document.getElementById(routes[hash]).classList.remove('hidden');
                if (hash === '#dashboard') loadDashboard();
            } else {
                // Default to dashboard if logged in, login if not
                window.location.hash = currentUser ? '#dashboard' : '#login';
            }
        }

        window.addEventListener('hashchange', handleRoute);

        // --- Auth ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const navAuth = document.getElementById('nav-auth');
            if (user) {
                document.getElementById('user-email').textContent = user.email;
                navAuth.classList.remove('hidden');
                if(window.location.hash === '#login' || window.location.hash === '') {
                    window.location.hash = '#dashboard';
                }
            } else {
                navAuth.classList.add('hidden');
                window.location.hash = '#login';
            }
            handleRoute();
        });

        document.getElementById('btn-google').onclick = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                showToast(error.message, true);
            }
        };

        document.getElementById('btn-signin').onclick = async () => {
            const e = document.getElementById('inp-email').value;
            const p = document.getElementById('inp-password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (err) { showToast(err.message, true); }
        };

        document.getElementById('btn-signup').onclick = async () => {
            const e = document.getElementById('inp-email').value;
            const p = document.getElementById('inp-password').value;
            try { await createUserWithEmailAndPassword(auth, e, p); } 
            catch (err) { showToast(err.message, true); }
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // --- Core Logic: Helper to read file as Base64 ---
        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // --- Upload Logic ---
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const progressContainer = document.getElementById('upload-progress-container');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('upload-status');
            const percentText = document.getElementById('upload-percent');

            progressContainer.classList.remove('hidden');
            statusText.textContent = "Reading file...";
            progressBar.style.width = '0%';

            try {
                const base64String = await readFileAsBase64(file);
                
                // Create chunks
                const totalLength = base64String.length;
                const chunks = [];
                for (let i = 0; i < totalLength; i += CHUNK_SIZE_BYTES) {
                    chunks.push(base64String.substring(i, i + CHUNK_SIZE_BYTES));
                }

                statusText.textContent = `Uploading metadata...`;

                // 1. Create Metadata Document
                const fileRef = await addDoc(collection(db, "files"), {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    chunkCount: chunks.length,
                    ownerId: currentUser.uid,
                    createdAt: serverTimestamp()
                });

                // 2. Upload Chunks to subcollection
                const totalChunks = chunks.length;
                for (let i = 0; i < totalChunks; i++) {
                    statusText.textContent = `Uploading chunk ${i + 1} of ${totalChunks}...`;
                    const pct = Math.round(((i) / totalChunks) * 100);
                    progressBar.style.width = `${pct}%`;
                    percentText.textContent = `${pct}%`;

                    // Upload chunk to subcollection
                    await setDoc(doc(db, "files", fileRef.id, "chunks", i.toString()), {
                        data: chunks[i],
                        index: i
                    });
                }

                progressBar.style.width = '100%';
                percentText.textContent = '100%';
                statusText.textContent = "Upload Complete!";
                showToast("File uploaded successfully!");
                
                setTimeout(() => {
                    window.location.hash = '#dashboard';
                    progressContainer.classList.add('hidden');
                    fileInput.value = '';
                }, 1000);

            } catch (err) {
                console.error(err);
                showToast("Upload failed: " + err.message, true);
                statusText.textContent = "Error";
                progressContainer.classList.add('hidden');
            }
        });

        // --- Dashboard Logic ---
        async function loadDashboard() {
            const list = document.getElementById('file-list');
            const empty = document.getElementById('empty-state');
            list.innerHTML = '<div class="col-span-full text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                const q = query(
                    collection(db, "files"), 
                    where("ownerId", "==", currentUser.uid),
                    orderBy("createdAt", "desc")
                );
                const snapshot = await getDocs(q);

                list.innerHTML = '';
                if (snapshot.empty) {
                    empty.classList.remove('hidden');
                    return;
                }
                empty.classList.add('hidden');

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt ? d.createdAt.toDate().toLocaleDateString() : 'Just now';
                    const sizeStr = (d.size / 1024 / 1024).toFixed(2) + ' MB';
                    
                    // Icon selection based on type
                    let iconClass = 'fa-file';
                    if(d.type.includes('image')) iconClass = 'fa-file-image';
                    else if(d.type.includes('pdf')) iconClass = 'fa-file-pdf';
                    else if(d.type.includes('video')) iconClass = 'fa-file-video';

                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl shadow hover:shadow-md transition border border-gray-100 flex flex-col';
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <i class="fa-regular ${iconClass} text-3xl text-blue-500"></i>
                            <button class="text-red-400 hover:text-red-600 delete-btn" data-id="${doc.id}">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                        <h3 class="font-semibold truncate mb-1" title="${d.name}">${d.name}</h3>
                        <p class="text-xs text-gray-400 mb-4">${sizeStr} â€¢ ${date}</p>
                        <a href="#view?id=${doc.id}" class="mt-auto text-center w-full py-2 bg-gray-50 hover:bg-gray-100 text-blue-600 rounded text-sm font-medium">
                            Open File
                        </a>
                    `;
                    list.appendChild(card);
                });

                // Attach delete handlers
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteFile(e.currentTarget.dataset.id));
                });

            } catch (err) {
                console.error(err);
                list.innerHTML = '<p class="text-red-500 col-span-full">Error loading files.</p>';
            }
        }

        async function deleteFile(id) {
            if(!confirm("Are you sure you want to delete this file? It cannot be undone.")) return;
            try {
                // Note: In a real app, use Cloud Functions to recursively delete subcollections. 
                // Here, we will just delete metadata to hide it, but chunks remain orphaned in Firestore 
                // (client-side recursive delete is heavy).
                // For this demo, we delete the meta doc.
                await deleteDoc(doc(db, "files", id));
                loadDashboard();
                showToast("File deleted.");
            } catch(err) {
                showToast("Delete failed: " + err.message, true);
            }
        }

        // --- View/Download Logic ---
        async function loadFileDetails(fileId) {
            const nameDisplay = document.getElementById('file-name-display');
            const metaDisplay = document.getElementById('file-meta-display');
            const downloadBtn = document.getElementById('btn-download');
            const statusMsg = document.getElementById('reassembly-status');
            const errorMsg = document.getElementById('error-msg');
            const previewContainer = document.getElementById('preview-container');
            const mediaPreview = document.getElementById('media-preview');

            // Reset UI
            nameDisplay.textContent = "Loading...";
            metaDisplay.textContent = "";
            downloadBtn.disabled = true;
            statusMsg.classList.add('hidden');
            errorMsg.classList.add('hidden');
            previewContainer.classList.add('hidden');
            mediaPreview.innerHTML = '';

            try {
                // 1. Get Metadata
                const fileSnap = await getDoc(doc(db, "files", fileId));
                if (!fileSnap.exists()) throw new Error("File not found");

                const meta = fileSnap.data();
                nameDisplay.textContent = meta.name;
                metaDisplay.textContent = `Size: ${(meta.size/1024).toFixed(1)} KB | Type: ${meta.type}`;
                
                downloadBtn.disabled = false;
                downloadBtn.onclick = () => assembleAndDownload(fileId, meta);

            } catch (err) {
                nameDisplay.textContent = "Error";
                errorMsg.textContent = err.message;
                errorMsg.classList.remove('hidden');
            }
        }

        async function assembleAndDownload(fileId, meta) {
            const statusMsg = document.getElementById('reassembly-status');
            const downloadBtn = document.getElementById('btn-download');
            const errorMsg = document.getElementById('error-msg');
            
            downloadBtn.disabled = true;
            statusMsg.classList.remove('hidden');
            errorMsg.classList.add('hidden');

            try {
                // 2. Fetch all chunks
                const q = query(collection(db, "files", fileId, "chunks"));
                const chunkSnaps = await getDocs(q);
                
                if (chunkSnaps.empty) throw new Error("No data found for this file.");

                // 3. Sort chunks by index (Firestore IDs were set to index, but query might not return ordered)
                const chunks = [];
                chunkSnaps.forEach(doc => {
                    chunks.push({ index: parseInt(doc.id), data: doc.data().data });
                });
                chunks.sort((a, b) => a.index - b.index);

                // 4. Stitch
                const fullBase64 = chunks.map(c => c.data).join('');

                // 5. Convert to Blob
                const response = await fetch(fullBase64);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                // 6. Handle Preview vs Download
                if (meta.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = "max-w-full h-auto mx-auto";
                    document.getElementById('media-preview').appendChild(img);
                    document.getElementById('preview-container').classList.remove('hidden');
                }

                // Trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = meta.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                statusMsg.classList.add('hidden');
                downloadBtn.disabled = false;

            } catch (err) {
                console.error(err);
                statusMsg.classList.add('hidden');
                errorMsg.textContent = "Download failed: " + err.message;
                errorMsg.classList.remove('hidden');
                downloadBtn.disabled = false;
            }
        }

        // --- UI Utilities ---
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white translate-y-0`;
            setTimeout(() => {
                t.classList.add('translate-y-20');
            }, 3000);
        }
    </script>
</body>
</html>

