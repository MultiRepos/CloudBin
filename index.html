<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CloudBin – chunked base64 file bin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui;margin:0;padding:1rem;background:#111;color:#eee}
    a{color:#0ff}
    button{background:#0ff;color:#000;border:0;padding:.5rem 1rem;cursor:pointer;margin:.25rem}
    input[type=file],input[type=email],input[type=password]{margin:.5rem 0;display:block;width:100%;max-width:300px}
    .card{background:#222;padding:1rem;margin:.5rem 0;border-radius:6px}
    .chunk{font-size:.7rem;color:#aaa}
  </style>
</head>
<body></body>

<!-- =========  ONE MODULE BLOCK  ========= -->
<script type="module">
/* ----------  Firebase  ---------- */
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {getAuth,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,signInWithPopup,GoogleAuthProvider,signOut} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {getFirestore,collection,doc,setDoc,getDoc,getDocs,query,orderBy,deleteDoc} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCT6JM1Njg3D9IwicsxJdo2MKjP3gGfUqU",
  authDomain: "cloudbin-dd657.firebaseapp.com",
  projectId: "cloudbin-dd657",
  storageBucket: "cloudbin-dd657.firebasestorage.app",
  messagingSenderId: "118062759614",
  appId: "1:118062759614:web:d98af3c2b125d131bf68ef",
  measurementId: "G-QYLJF2DWCX"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const googleProvider = new GoogleAuthProvider();

/* ----------  CONFIG  ---------- */
const CHUNK_MAX = 900_000;   // < 1 MB

/* ----------  AUTH  ---------- */
let user = null;
onAuthStateChanged(auth, u => { user = u; route(); });

/* ----------  ROUTER  ---------- */
window.addEventListener("hashchange", route);
window.addEventListener("load", route);

function route(){
  if (!user) return renderAuth();
  const [hash, search] = location.hash.split("?");
  const params = new URLSearchParams(search || "");
  const id = params.get("id");

  if (hash === "#upload")        renderUpload();
  else if (hash === "#view" && id) renderView(id);
  else                             renderList();
}

/* ----------  AUTH UI  ---------- */
function renderAuth(){
  document.body.innerHTML = `
    <h2>CloudBin – sign in</h2>
    <input type="email" id="em" placeholder="email"/>
    <input type="password" id="pw" placeholder="password"/>
    <button onclick="emailSignIn()">Sign In</button>
    <button onclick="emailSignUp()">Sign Up</button>
    <hr>
    <button onclick="googleSignIn()">Sign in with Google</button>
  `;
  window.emailSignIn  = () => signInWithEmailAndPassword(auth, em.value, pw.value).catch(alert);
  window.emailSignUp  = () => createUserWithEmailAndPassword(auth, em.value, pw.value).catch(alert);
  window.googleSignIn = () => signInWithPopup(auth, googleProvider).catch(alert);
}

/* ----------  UPLOAD  ---------- */
async function uploadFile(file){
  const base64 = await fileToBase(file);
  const chunks = chunkString(base64, CHUNK_MAX);
  const fileId = crypto.randomUUID();
  const meta = {
    name: file.name,
    type: file.type,
    size: file.size,
    chunks: chunks.length,
    uploaded: Date.now(),
    owner: user.uid
  };
  const payload = { meta };
  chunks.forEach((c, i) => payload["chunk" + i] = c);

  await setDoc(doc(db, "files", fileId), payload);
  location.hash = "#view?id=" + fileId;
}

function fileToBase(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}
function chunkString(str, len){
  const arr = [];
  for (let i = 0; i < str.length; i += len) arr.push(str.slice(i, i + len));
  return arr;
}

function renderUpload(){
  document.body.innerHTML = `
    <h2>Upload file</h2>
    <input type="file" id="fu"/>
    <button onclick="uploadGo()">Upload</button>
    <button onclick="signOut(auth)">Logout</button>
    <a href="#">← back</a>
  `;
  window.uploadGo = () => {
    const f = document.getElementById("fu").files[0];
    if (!f) return alert("Pick a file");
    uploadFile(f);
  };
}

/* ----------  LIST  ---------- */
async function renderList(){
  const snap = await getDocs(query(collection(db, "files"), orderBy("meta.uploaded", "desc")));
  let html = `<h2>CloudBin files</h2><a href="#upload">+ upload</a> | <button onclick="signOut(auth)">Logout</button>`;
  snap.forEach(d => {
    const m = d.data().meta;
    html += `<div class="card">
      <strong>${m.name}</strong> (${(m.size / 1024).toFixed(1)} KB)
      <div class="chunk">${m.chunks} chunks</div>
      <a href="#view?id=${d.id}">view / download</a>
    </div>`;
  });
  document.body.innerHTML = html;
}

/* ----------  VIEW / DOWNLOAD  ---------- */
async function renderView(id){
  const snap = await getDoc(doc(db, "files", id));
  if (!snap.exists()) return document.body.innerHTML = `File not found <a href="#">home</a>`;
  const data = snap.data();
  const meta = data.meta;

  let base = "";
  for (let i = 0; i < meta.chunks; i++) base += data["chunk" + i];
  const url = "data:" + meta.type + ";base64," + base;

  document.body.innerHTML = `
    <h2>${meta.name}</h2>
    <p>Type: ${meta.type} | Size: ${(meta.size / 1024).toFixed(1)} KB</p>
    <a href="${url}" download="${meta.name}"><button>Download</button></a>
    <button onclick="if(confirm('Delete?')) del('${id}')">Delete</button>
    <button onclick="signOut(auth)">Logout</button>
    <a href="#">← back</a>
  `;
  window.del = async id => { await deleteDoc(doc(db, "files", id)); location.hash = ""; };
}

</script>
</html>
